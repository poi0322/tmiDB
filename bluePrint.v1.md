# tmiDB 설계서 v1.0

---

## 1. 개요 (Overview)

**tmiDB(Too-Much-Information Database)**는 특정 **대상(Target)**에 대한 모든 정보를 중앙에서 관리하고, 실시간으로 스트리밍하기 위해 설계된 데이터베이스 시스템입니다.

PostgreSQL, TimescaleDB 등 검증된 오픈소스를 기반으로 구축되었으며, 모든 구성 요소는 MIT, Apache-2.0 등 퍼미시브 라이선스만을 사용하여 상용 서비스에 제약 없이 자유롭게 활용할 수 있도록 설계되었습니다.

## 2. 핵심 개념 (Core Concepts)

tmiDB는 세 가지 핵심 요소로 동작합니다.

- **대상 (Target)**: 정보를 수집하고 관리할 기본 단위입니다. 사람, 장비, 서비스 등 모든 것이 대상이 될 수 있습니다.
- **스피커 (Speaker)**: 대상에 대한 정보를 생성하고 데이터베이스에 쓰는 주체입니다. API 호출, 직접적인 DB 쿼리, 또는 tmiDB가 특정 URL에서 데이터를 주기적으로 스크랩하는 자동화된 에이전트 등 다양한 형태가 될 수 있습니다.
- **리스너 (Listener)**: 특정 대상의 정보를 구독하는 주체입니다. 대상에 대한 읽기 권한을 부여받으면, 자동 생성된 REST API 엔드포인트에 접근할 수 있으며, WebSocket을 통해 정보 업데이트를 실시간으로 스트리밍 받을 수 있습니다.

### 2.1. 주요 특징

- **동적 스키마**: MongoDB처럼 대상에 대한 정보 항목(컬럼)을 미리 정의할 필요 없이 자유롭게 추가할 수 있습니다. 정보 스키마가 변경될 때마다 내부적으로 버전이 관리됩니다.
- **자동화된 API 생성 및 버전 관리**: 대상의 데이터 구조가 변경되면, 그에 맞춰 REST API가 자동으로 업데이트되고 버전이 부여됩니다. 이는 gRPC와 유사한 방식으로 API 호환성을 보장합니다.
- **유연한 데이터 수집**: Speaker는 DB 쿼리, REST API 등 다양한 방식으로 데이터를 입력할 수 있습니다. 또한, 특정 웹 페이지의 URL을 등록하면 tmiDB 내부의 코드가 주기적으로 해당 페이지의 정보를 수집하여 저장하는 기능도 제공합니다.

## 3. 아키텍처 (Architecture)

### 3.1. 시스템 구성 요소

tmiDB는 기능적으로 독립적인 여러 프로젝트 모듈과 검증된 오픈소스 데이터베이스 기술의 조합으로 구성됩니다.

#### 3.1.1. 기반 기술 스택

| 계층              | 컴포넌트                  | 라이선스         | 비고                          |
| ----------------- | ------------------------- | ---------------- | ----------------------------- |
| **DB 엔진**       | PostgreSQL 15             | PostgreSQL (BSD) | 기반 RDB                      |
| **시계열**        | TimescaleDB 2.18 **코어** | Apache-2.0       | `compress_chunks` 까지만 사용 |
| **공간 / 거리**   | `cube` + `earthdistance`  | BSD              | 반경·근접 질의                |
| **객체 스토리지** | SeaweedFS S3 Gateway      | Apache-2.0       | MinIO 대체                    |
| **메시지 버스**   | NATS JetStream            | Apache-2.0       | ETL·알람                      |

#### 3.1.2. 프로젝트 모듈 구조

**핵심 설계 원칙: 독립적인 프로젝트 모듈 (Independent Project Modules)**

각 기능 모듈은 자체 소스 코드, 의존성, 빌드 및 배포 설정을 가지며 독립적으로 개발, 테스트, 배포될 수 있습니다.

- **tmidb-core/**: 데이터베이스, 웹 콘솔, 핵심 API 등 tmiDB의 기본 기능을 제공하는 코어 프로젝트. `poi0322/tmidb-core:0.1` 이미지를 빌드합니다.
- **tmidb-mqtt/**: MQTT 프로토콜을 통한 데이터 수집 및 publish를 담당하는 확장 모듈. `poi0322/tmidb-mqtt:0.1` 이미지를 빌드합니다.
- **tmidb-realtime/**: WebSocket을 통한 실시간 데이터 수집 및 스트리밍을 담당하는 확장 모듈. `poi0322/tmidb-realtime:0.1` 이미지를 빌드합니다.
- **(TODO) tmidb-poller/**: 데이터 수집기 프로젝트. `poi0322/tmidb-poller:0.1` 이미지를 빌드합니다.

### 3.2. 쓰기 경로 전략 (Write Path Strategy)

- **동기 쓰기 (Synchronous Write)**: 사용자 생성, 설정 변경 등 즉각적인 피드백이 필요하고 트랜잭션이 중요한 요청입니다. API 게이트웨이가 직접 DB 커넥션을 사용하여 처리합니다.
- **비동기 쓰기 (Asynchronous Write)**: IoT 센서 데이터, 로그 등 대량으로 수집되는 데이터입니다. 데이터 수집기(mqtt)는 받은 데이터를 NATS에 발행하기만 합니다. 실제 DB에 쓰는 작업은 Worker가 NATS 큐를 통해 순차적이고 안정적으로 처리하여 DB 부하를 최소화합니다.

### 3.3. 고급 아키텍처 패턴

- **리스너별 동적 API 및 실시간 필터링**:

  - **문제:** 모든 리스너가 동일한 API를 사용하는 대신, `api/리스너A`처럼 자신만의 엔드포인트를 갖고 구독한 데이터만 필터링해서 받고자 합니다.
  - **해결책:** tmiDB 스택 앞에 API 게이트웨이 또는 인증/프록시 서비스를 배치합니다. 리스너별 구독 정보를 별도 테이블에 저장하고, 게이트웨이가 이를 기반으로 실제 DB 쿼리를 동적으로 생성하여 데이터를 필터링합니다. WebSocket 또한 프록시를 통해 구독 필드에 해당하는 메시지만 전달합니다.

- **대용량 파일 처리 (이벤트 알림 방식)**:
  - **문제:** 이미지, 동영상 등 대용량 파일을 WebSocket으로 직접 전송하는 것은 비효율적입니다.
  - **해결책:** 파일은 S3 호환 스토리지(SeaweedFS)를 통해 전달하고, WebSocket으로는 파일 변경 이벤트 알림만 전송합니다. 클라이언트는 알림에 포함된 메타데이터를 이용해 S3에서 직접 파일을 다운로드합니다.

## 4. 보안 및 인증

API 및 서비스 접근은 두 가지 방식으로 인증됩니다.

1.  **ID / Password**: 사용자 계정의 아이디와 비밀번호를 이용한 기본 인증입니다.
2.  **API 토큰 (`database-token`)**: 사용자가 발급받은 Bearer 토큰을 이용한 인증입니다. 자동화된 스크립트나 외부 서비스 연동에 권장됩니다.

### 4.1. 토큰 관리 정책

- **발급**: 사용자는 여러 개의 API 토큰을 생성하여 용도에 따라 관리할 수 있습니다.
- **권한**:
  - **관리자 (Admin)**: 모든 사용자의 토큰 목록을 조회하고 강제 삭제할 수 있습니다.
  - **일반 사용자 (Viewer 등)**: 자신이 발급받은 토큰만 조회하고 관리할 수 있습니다.

## 5. 실행 및 배포

프로젝트 실행은 Docker Compose를 통해 오케스트레이션됩니다. `README.md`에 명시된 대로 `tmidb-core`를 먼저 실행한 후, 필요한 확장 모듈들을 순차적으로 실행합니다.

자세한 실행 방법은 `README.ko.md` 파일을 참고하십시오.

## 6. 초기 로드맵

| 단계 | 주요 목표                                                              |
| ---- | ---------------------------------------------------------------------- |
| 1    | 모노레포 구성, Docker Compose 기반 실행 환경 구축, 기본 DB 스키마 정의 |
| 2    | Polling을 통한 데이터 수집 및 `raw_bucket` 테이블에 INSERT 기능 구현   |
| 3    | AI 매핑을 통한 데이터 정규화 및 정규 테이블로의 이전                   |
| 4    | WebSocket을 이용한 실시간 데이터 스트리밍(`stream_def` 적용)           |
| 5    | 임계값 기반의 알람 엔진(alarm_engine) 구현                             |
| 6    | 관리자 콘솔 MVP 개발 및 `tmictl` CLI 배포                              |

## 7. 라이선스

tmiDB 전체 스택은 **MIT, Apache-2.0, BSD** 등 퍼미시브 라이선스만으로 구성됩니다. 이를 통해 tmiDB의 코드를 수정하거나, 상용 제품에 포함하여 판매하거나, SaaS 형태로 재배포하는 모든 행위가 법적 제약 없이 가능합니다.

각 Go/TypeScript 소스 파일에는 `SPDX-License-Identifier: MIT` 헤더를 포함하는 것을 원칙으로 합니다.
