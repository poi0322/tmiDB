name: Update Submodules and Build Image

on:
  # ë§¤ì¼ í•œêµ­ ì‹œê°„ ì˜¤ì „ 9ì‹œì— ì‹¤í–‰ (UTC 00:00)
  schedule:
    - cron: "0 0 * * *"

  # ìˆ˜ë™ ì‹¤í–‰ ê°€ëŠ¥
  workflow_dispatch:

  # ê°œë³„ submodule ì €ì¥ì†Œì—ì„œ pushê°€ ë°œìƒí•  ë•Œ ì‹¤í–‰ (webhook ì„¤ì • í•„ìš”)
  repository_dispatch:
    types: [submodule-updated]

jobs:
  update-and-build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout ë©”ì¸ ì €ì¥ì†Œ
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          submodules: recursive

      - name: Git ì‚¬ìš©ì ì„¤ì •
        run: |
          git config --global user.name 'github-actions[bot]'
          git config --global user.email 'github-actions[bot]@users.noreply.github.com'

      - name: Submodules ìµœì‹  ë²„ì „ìœ¼ë¡œ ì—…ë°ì´íŠ¸
        run: |
          git submodule update --remote --merge

      - name: ë³€ê²½ì‚¬í•­ í™•ì¸
        id: verify-changed-files
        run: |
          if [ -n "$(git status --porcelain)" ]; then
            echo "changed=true" >> $GITHUB_OUTPUT
            CHANGES=$(git status --porcelain | grep ' M ' | awk '{print $2}' | paste -sd ', ' -)
            echo "changes_list=${CHANGES}" >> $GITHUB_OUTPUT
          else
            echo "changed=false" >> $GITHUB_OUTPUT
          fi

      - name: ë³€ê²½ì‚¬í•­ì´ ì—†ì„ ê²½ìš° ì¤‘ë‹¨
        if: steps.verify-changed-files.outputs.changed != 'true'
        run: echo "â„¹ï¸ ëª¨ë“  submodulesê°€ ì´ë¯¸ ìµœì‹  ë²„ì „ì…ë‹ˆë‹¤. ë¹Œë“œë¥¼ ê±´ë„ˆëœë‹ˆë‹¤."

      - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹ ë° í‘¸ì‹œ
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
          COMMIT_MSG="ğŸ¤– Auto-update submodules: ${{ steps.verify-changed-files.outputs.changes_list }} (${TIMESTAMP})"
          git add .
          git commit -m "${COMMIT_MSG}"
          git push

      - name: Docker Hub ë¡œê·¸ì¸
        if: steps.verify-changed-files.outputs.changed == 'true'
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Docker ë©”íƒ€ë°ì´í„° ì„¤ì • (íƒœê·¸ ë“±)
        if: steps.verify-changed-files.outputs.changed == 'true'
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: your-dockerhub-username/tmidb-core
          tags: |
            type=schedule,pattern=nightly-{{date 'YYYYMMDD'}}
            type=sha,prefix=
            latest

      - name: Docker Buildx ì„¤ì •
        if: steps.verify-changed-files.outputs.changed == 'true'
        uses: docker/setup-buildx-action@v3

      - name: tmidb-core ì´ë¯¸ì§€ ë¹Œë“œ ë° í‘¸ì‹œ
        if: steps.verify-changed-files.outputs.changed == 'true'
        uses: docker/build-push-action@v5
        with:
          context: ./tmidb-core
          file: ./tmidb-core/Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max

      - name: ì—…ë°ì´íŠ¸ ë° ë¹Œë“œ ê²°ê³¼ ì¶œë ¥
        if: steps.verify-changed-files.outputs.changed == 'true'
        run: |
          echo "âœ… Submodulesê°€ ì„±ê³µì ìœ¼ë¡œ ì—…ë°ì´íŠ¸ë˜ê³ , ì´ë¯¸ì§€ê°€ ë¹Œë“œ/í‘¸ì‹œë˜ì—ˆìŠµë‹ˆë‹¤!"
          echo "Updated submodules: ${{ steps.verify-changed-files.outputs.changes_list }}"
          echo "Pushed image tags: ${{ steps.meta.outputs.tags }}"

      - name: ì—…ë°ì´íŠ¸ ê²°ê³¼ ì¶œë ¥ (ë³€ê²½ì‚¬í•­ ì—†ìŒ)
        if: steps.verify-changed-files.outputs.changed != 'true'
        run: |
          echo "â„¹ï¸ ëª¨ë“  submodulesê°€ ì´ë¯¸ ìµœì‹  ë²„ì „ì…ë‹ˆë‹¤."
